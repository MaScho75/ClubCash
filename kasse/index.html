<!DOCTYPE html>
<html lang="de">

<!--
 * This file is part of ClubCash.
 * x
 * ClubCash is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published
 * by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * ClubCash is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with ClubCash. If not, see <https://www.gnu.org/licenses/>.
-->

<!-- 
DOKUMENTATION DER FUNKTIONEN
============================

KONFIGURATION & INITIALISIERUNG
--------------------------------
configuration() - Wendet Konfigurationseinstellungen an (Wartungsmodus, Berechtigungen, Bildschirmschoner)

DATENVERWALTUNG
---------------
loadJSON(url) - Lädt JSON-Dateien vom Netzwerk oder aus dem Cache bei Offline-Betrieb
loadCSV(url) - Lädt CSV-Dateien und konvertiert sie in ein JSON-Array-Format

OFFLINE-FUNKTIONALITÄT
----------------------
updateOfflineCounter() - Aktualisiert die Anzeige der offline gespeicherten Verkäufe
speichereOfflineVerkauf(verkaufsdaten) - Speichert Verkäufe lokal wenn keine Internetverbindung besteht
syncOfflineData() - Synchronisiert offline gespeicherte Verkäufe mit dem Server sobald die Verbindung wiederhergestellt ist

BENUTZEROBERFLÄCHE & NAVIGATION
--------------------------------
toggleMenu() - Öffnet/schließt das Hauptmenü
preisfenster_öffnen() - Öffnet das Fenster mit der Preisliste
eingabestopp() - Deaktiviert die Tastatureingabe und blendet bestimmte Buttons aus
Fehlerton() - Gibt einen akustischen Fehlerton aus
zeigeHaken() - Zeigt eine Häkchen-Animation nach erfolgreicher Aktion an
showScreensaver() - Aktiviert den Bildschirmschoner
resetTimer() - Setzt den Timer für den Bildschirmschoner zurück

PRODUKTVERWALTUNG
-----------------
direktwahl() - Erstellt Schnellwahl-Buttons für die ersten 12 Produkte
produktprüfung(EANr) - Überprüft ob ein Produkt existiert und fügt es dem Warenkorb hinzu
preisliste() - Zeigt die vollständige Preisliste aller Produkte an
aus_preisliste_buchen(EAN_Preisliste) - Bucht ein Produkt direkt aus der Preisliste
mittagspreis() - Ermöglicht die Anpassung des Essenspreises
update_mittagspreis(neuerPreis) - Speichert den geänderten Essenspreis in der Datenbank

WARENKORB-FUNKTIONEN
--------------------
warenkorbüberschrift() - Setzt die Kopfzeile des Warenkorbs zurück
warenkorbaddition(produkt) - Fügt ein Produkt zur Warenkorb-Anzeige hinzu und aktualisiert die Summe
manuell() - Öffnet die Tastatur für manuelle Preiseingaben
meingabe(x) - Verarbeitet Tastatureingaben für manuelle Buchungen und Mengenangaben

KUNDENVERWALTUNG
----------------
kundenprüfung(KundenNr) - Prüft ob ein Kunde existiert und verarbeitet den Warenkorb oder zeigt Kontoübersicht
kundenkontoübersicht(Schlüsselnummer) - Zeigt alle Umsätze eines bestimmten Kunden an

BERICHTSFUNKTIONEN
------------------
tagesabrechnung() - Zeigt detaillierte Tagesabrechnung aller Verkäufe an
tageszusammenfassung() - Zeigt zusammengefasste Verkaufsstatistik nach Produkten gruppiert
kundentagesübersicht() - Zeigt Tagesumsätze gruppiert nach Kunden an

SYSTEMFUNKTIONEN
----------------
systeminfo() - Zeigt Systeminformationen und Cache-Status an
info() - Zeigt allgemeine Informationen zum Kassensystem an
sonderfunktionen(EANr) - Verarbeitet spezielle EAN-Codes für administrative Funktionen

DATENÜBERTRAGUNG
----------------
übertragung_umsatz(data) - Überträgt Verkaufsdaten an den Server oder speichert sie offline
-->

<head>
    <!-- Zeichensatz auf UTF-8 setzen -->
    <meta charset="UTF-8">

    <!-- Cache-Control Headers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Skalierbarkeit für mobile Geräte sicherstellen -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Lokale Schriftart vorladen -->
    <link rel="preload" href="../grafik/carlito-v3-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
    
    <!-- CSS-Dateien laden -->
    <link rel="stylesheet" href="./style-kasse.css">
    <link rel="stylesheet" href="../farben.css">

    <!-- Lokale Schriftart einbinden -->
    <style>
        @font-face {
            font-family: 'Carlito';
            src: url('../grafik/carlito-v3-latin-regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgb(0, 0, 0);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999; /* Preloader wird oben angezeigt */
        }

        .spinner-container {
            position: relative;
            width: 170px;
            height: 170px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            position: absolute;
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-top: 8px solid #fff;
            border-radius: 50%;
            width: 170px;
            height: 170px;
            animation: spin 1s linear infinite;
        }

        .preloader-logo {
            position: relative;
            width: 100px;
            height: 100px;
            z-index: 1;
        }

        /* Animation für die Sanduhr */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>

    <!-- Lokales jQuery einbinden -->
    <script src="./lib/jquery-3.6.0.min.js"></script>

    <title>ClubCash</title>

    <!-- Anweisung an Suchmaschinen, die Seite NICHT zu indexieren -->
    <meta name="robots" content="noindex, nofollow">

    <link rel="manifest" href="../manifest.json">

</head>

<body>

    <!-- Preloader anzeigen -->
    <div class="preloader" id="preloader">
        <div class="spinner-container">
            <div class="spinner"></div>
            <img src="../grafik/ClubCashLogo-gelbblauweiss.svg" alt="ClubCash" class="preloader-logo">
        </div>
    </div>

    <div id="preisfenster">

        <div class="scrollbalken" id="preisfenster_inhalt">
            <h1 id="preisliste_überschrift">Produktliste</h1>
            <button id="preisliste_schließen" onclick="preisfenster_schliessen()">X</button>
            <table id="preislistentabelle" border="0">
                <thead>
                    <tr>
                        <th class="produktspalte2">Produkt</th>
                        <th class="preisspalte2">Preis</th>
                        <th class="leerspalte"></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <div id="display">

        <div id="navbar" onclick="toggleMenu()">
            <div class="menu-icon">☰</div>
            <div class="menu">
                <button class="menubuttondown" id="bt_tagesabrechnung" onclick="tagesabrechnung();">Tagesabrechnung</button>
                <button class="menubuttondown" id="bt_tageszusammenfassung" onclick="tageszusammenfassung();">Tageszusammenfassung</button>
                <button class="menubuttondown" id="bt_kundentagesübersicht" onclick="kundentagesübersicht();">Kunden Tagesübersicht</button>
                <button class="menubuttondown" id="bt_mittagspreis" onclick="mittagspreis();">Preisanpassung Essen</button>
                <button class="menubuttondown" id="bt_info" onclick="info();">Programminfos</button>
                <button class="menubuttondown" id="bt_systeminfo" onclick="systeminfo()">Systeminfo</button>
            </div>
        </div>

        <div id="linkeSpalte">

            <div id="statusfeld">
                Guten Tag!
            </div>

            <div class="scrollbalken" id="datenfeld">
                <table id="warenkorbtabelle" border="0">
                    <thead></thead>
                    <tbody>
                        <tr>
                            <td class="zentriert" id="warenkorb-initial-message">Bitte Produkt scannen oder Chip auflegen.</td>
                        </tr>
                        <tr>
                            <td>
                                <div id="direktwahl"></div>
                            </td>
                    </tbody>
                </table>
            </div>

            <div id="copyright">
                <p class="zentriert" id="copyright-text"><span id="verein">VEREIN</span> - &copy; 2026 Marcel Schommer - Version: <span id="version">x.x.x</span></p>
            </div>
        </div>

        <div id="rechteSpalte">

            <div id="logo">
                <img id="logo-bild" src="../grafik/ClubCashLogo-gelbblauschwarz.svg" alt="ClubCash">
            </div>

            <div id="menubar">
                <p class="zentriert" id="terminal-info-text"><b>Terminal <span id="terminal"></span></b></p>
                    <div id="offlineFenster">
                        <p class="zentriert" id="offline-status-text"><b>System offline!</b> (<span id="offlineDS">0</span>)</p>
                    </div>
                <button id="Bt_preisfenster" onclick="preisfenster_öffnen()">Produkte</button>
                <button id="Bt_manuelleBuchung" onclick="manuell();">manuelle Buchung</button>
                <button id="abbruch" onclick="NeuLaden();">Abbruch</button>                
            </div>

            <div id="summenkasten">
                <span id=summenfeld>0.00</span>&nbsp;€
            </div>

        </div>

        <div id=tastatur>
            <p class="preiseingabe"><b><span id="zifferneingabefeld">0.00</span> <span id="einheit">€</span></b></p>
            <table class="tastaturtabelle">
                <tr>
                    <td onclick="meingabe(1)">1</td>
                    <td onclick="meingabe(2)">2</td>
                    <td onclick="meingabe(3)">3</td>
                </tr>
                <tr>
                    <td onclick="meingabe(4)">4</td>
                    <td onclick="meingabe(5)">5</td>
                    <td onclick="meingabe(6)">6</td>
                </tr>
                <tr>
                    <td onclick="meingabe(7)">7</td>
                    <td onclick="meingabe(8)">8</td>
                    <td onclick="meingabe(9)">9</td>
                </tr>
                <tr>
                    <td onclick="meingabe(0)">0</td>
                    <td id="BT_EingabeBestätigt" class="BT_Eingabe" onclick="meingabe('E')">E</td>
                    <td id="BT_Abbruch" onclick="NeuLaden();">X</td>   
                </tr>
            </table>
        </div>

        <div id="checkmark-container">
            <svg width="25cqw" height="25cqw" viewBox="0 0 100 100">
                <path id="checkmark" d="M25 50 L45 70 L75 35"
                    stroke="#4CAF50" stroke-width="8"
                    fill="none"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-dasharray="100"
                    stroke-dashoffset="100" />
            </svg>
        </div>

    </div>
        
    <!-- Bildschirmschoner -->
    <div class="box_zentrieren" id="bildschirmschoner" onclick="window.location.reload(true);">
        <img src="../grafik/ClubCashLogo-gelbblauweiss.svg" alt="ClubCash" class="scaling-img">
        
    </div>

    <!-- Wartungs Bildschrim  -->
    <div id="Wartungsfenster">
            <img src="../grafik/ClubCashLogo-gelbblauweiss.svg" alt="ClubCash" id="wartungs-logo">
         <h1>System ist im Wartungsmodus!</h1>
    </div>

    <!-- Offline Bildschrim  -->
    <div id="OfflineBildschirm">
            <img src="../grafik/ClubCashLogo-gelbblauweiss.svg" alt="ClubCash" id="offline-logo">
         <h1>System ist Offline</h1>
         <p>Bitte stellen Sie die Internetverbindung her...</p>
    </div>

    

    <script>

        // Variablen
            let warenkorb = [];
            let summe = 0.00;
            let eingabe = "";
            let eingabestring = "";
            let timeout; //Bildschirmschone Timer
            let produkte = [];
            let kunden = [];
            let config = [];
            let spritt = false; // Variable für die Spritt
            let ProduktTemp = []; // Temporäre Variable für das Produkt, wenn es sich um ein Produkt mit Mengeneingabe handelt
            let isSyncing = false; // Verhindert gleichzeitige Synchronisationen

            const display_fenster = document.getElementById("display");
            const datenfeld = document.getElementById("datenfeld");
            const warenkorbtabelle = document.getElementById("warenkorbtabelle");
            const tbody = document.querySelector("#warenkorbtabelle tbody");
            const statusfeld = document.getElementById("statusfeld");
            const summenfeld = document.getElementById("summenfeld");
            const menubar = document.getElementById("menubar");
            const thead = document.querySelector("#warenkorbtabelle thead");
            const preisfenster = document.getElementById("preisfenster");
            const tastatur = document.getElementById("tastatur");
            const navbar = document.getElementById("navbar");
            const div_Bildschirmschoner = document.getElementById("bildschirmschoner");
            const Bt_manuelleBuchung = document.getElementById("Bt_manuelleBuchung");
            const preislisten_tbody = document.querySelector("#preislistentabelle tbody");
            const statusbar = document.getElementById("statusfeld");
            const zifferneingabefeld = document.getElementById("zifferneingabefeld");
            const preloader = document.getElementById("preloader");

        // Logs
            const logs = {
                log: [],
                warn: [],
                error: [],
                table: []
            };

            ["log", "warn", "error", "table"].forEach(type => {
                const original = console[type];
                console[type] = (...args) => {
                    logs[type].push(args);
                    original.apply(console, args);
                };
            });    


        //Prüfung, ob offine Speicherung möglich ist, durch darstellung des letzten Speicherzeitpunkts
            if (localStorage.getItem('letzterSpeicherZeitpunkt')) {
                console.log("Letzter Speicherzeitpunkt im Lokalspeicher: " + localStorage.getItem('letzterSpeicherZeitpunkt'));
            } else {
                console.log("Kein letzter Speicherzeitpunkt im Lokalspeicher gefunden. Wert wird auf jetzt gesetzt.");
                localStorage.setItem('letzterSpeicherZeitpunkt', new Date().toISOString());
                console.log("Letzter Speicherzeitpunkt im Lokalspeicher: " + localStorage.getItem('letzterSpeicherZeitpunkt'));
            }

        //Backup der umsatz.csv
            fetch("backup.php")
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.text();
                })
                .then(result => console.log(result))
                .catch(error => console.error("Error:", error));


        // Terminal ermitteln aus der URL https://host/index.html?zahl=42
            const urlParams = new URLSearchParams(window.location.search);
            let terminal = urlParams.get("terminal"); // Holt den Wert von "terminal" aus der URL

        // Anzeigen der akteullen Terminalnummer
            if (terminal == null) {
                if (localStorage.getItem('terminalNummer')) {
                    terminal = localStorage.getItem('terminalNummer'); // Wenn kein "Terminal" in der URL, dann aus dem lokalen Speicher
                } else {
                    terminal = "X"; // Wenn kein "Terminal" in der URL und nicht im lokalen Speicher, dann X
                }
            }
            localStorage.setItem('terminalNummer', terminal); // Speichert die Terminalnummer im lokalen Speicher
            document.getElementById("terminal").innerText = terminal;


        // Eingabekontrolle - Eventhandler
            let tastenkontrolle = function(event) {

                if (event.key === "Enter" && eingabe !== "") { //Sollte nur Enter gedrückt worden sein, wird der folgende Code nicht ausgeführt. 

                    tastatur.style.display = 'none'; //soltte die Tastatur noch offen sein, wird sie geschlossen
                    preisfenster.style.display = 'none'; //sollte das Preisfenster noch offen sein, wird es geschlossen
                    document.activeElement.blur(); // ist notwendig, damit nicht ein Button fokussiert bleibt und nach dem Enter eine Aktion auslöst

                    produktprüfung(eingabe);

                    kundenprüfung(eingabe);
                    
                    sonderfunktionen(eingabe);

                    if (eingabe) {
                        statusfeld.innerText = "Kein Produkt und kein Kunde erkannt."
                        Fehlerton();
                        eingabe = "";
                    }
                }

                if (event.key.length === 1) {
                    eingabe += event.key;
                    console.log("Eingabe hat den Wert: " + eingabe);
                    preisfenster.style.display = 'none';
                }
            }

            document.addEventListener("keydown", tastenkontrolle);

        // Daten laden
            // Lade die JSON-Dateien mit den Produkten und Kunden
            // und aktualisiere die Preisliste und die Direktwahl
            Promise.all([
                    loadJSON("../daten/produkte.json"), 
                    loadJSON("../daten/kunden.json"),
                    loadJSON("../daten/config.json"),
                    loadJSON("../daten/externe.json"),
                    initializeServiceWorker()
                ])
                .then(([geladeneProdukte, geladeneKunden, geladeneConfig, geladeneExterne]) => {
                    produkte = geladeneProdukte;
                    kunden = geladeneKunden;
                    config = geladeneConfig;
                    externe = geladeneExterne;

                    //Kopiere im Array externe die Spalte "Schlüssel" in die Spalte "uid"
                        externe.forEach(kunde => {
                            if (!kunde.uid) {
                                kunde.uid = kunde.schlüssel;
                            }
                        });
                    kunden = kunden.concat(externe); // Hänge die datensätze externe an die kunden an
                    document.getElementById("verein").innerText = config.VereinsnameAbk;
                    configuration();
                    preisliste();
                    direktwahl();
                    
                    preloader.style.display = "none"; // Preloader ausblenden
                    
                    // Offline-Prüfung nach dem Laden der Config
                    if (!navigator.onLine && config.OfflineErlaubt == 'false') {
                        console.log('Offline nicht erlaubt');  
                        if (OfflineBildschirm) {
                            OfflineBildschirm.style.display = 'block';
                            eingabestopp();
                        }
                    }
                })
                .catch(error => {
                console.error("Error loading data:", error);
                });    


        // Offline-Funktionalität
            let isOnline = navigator.onLine;
            let offlineFenster = document.getElementById('offlineFenster');
            let OfflineBildschirm = document.getElementById('OfflineBildschirm');

            // Initiale Offline-Prüfung
            if (!navigator.onLine) {
                isOnline = false;
                if (offlineFenster) offlineFenster.style.visibility = 'visible';
                updateOfflineCounter();
            }

            window.addEventListener('online', () => {
                console.log('Online-Event erkannt');
                isOnline = true;
                offlineFenster.style.visibility = 'hidden';
                OfflineBildschirm.style.display = 'none';
                updateOfflineCounter();
                syncOfflineData();
            });

            window.addEventListener('offline', () => {
                console.log('Offline-Event erkannt');
                if (config && config.OfflineErlaubt == 'false') {
                    OfflineBildschirm.style.display = 'block';
                    eingabestopp();
                }
                isOnline = false;
                offlineFenster.style.visibility = 'visible';
                updateOfflineCounter();
            });
        

        // Zeite an, wie viele Datensätze offline gespeichert sind
            updateOfflineCounter();

    
        // Wenn online ist, versuche offline Daten zu synchronisieren
            console.log("Seite geladen. Online-Status:", isOnline);
            if (isOnline) {
                console.log("Starte Synchronisation offline Daten nach dem Laden der Seite");
                syncOfflineData();
                console.log("Synchronisiere offline Daten nach dem Laden der Seite");
                console.table(localStorage.getItem('offlineVerkäufe'));
            }
            


        // ========================================
        // KONFIGURATION & INITIALISIERUNG
        // ========================================

        function NeuLaden() {
            preloader.style.display = "flex";
            window.location.reload(true);
        }

        function initializeServiceWorker() {        
        // Service Worker registrieren
            if ('serviceWorker' in navigator) {
                console.log('Service Worker wird registriert...');
                console.log('Current URL:', window.location.href);
                console.log('Base URL:', window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1));
                
                // Erst prüfen ob sw.js erreichbar ist
                fetch('sw.js')
                    .then(response => {
                        console.log('sw.js fetch status:', response.status, response.statusText);
                        console.log('sw.js content-type:', response.headers.get('content-type'));
                        if (!response.ok) {
                            throw new Error('sw.js nicht erreichbar: ' + response.status);
                        }
                        return response.text();
                    })
                    .then(swCode => {
                        console.log('sw.js geladen, Länge:', swCode.length);
                        // Jetzt versuchen zu registrieren
                        return navigator.serviceWorker.register('sw.js', { 
                            scope: './',
                            type: 'classic'
                        });
                    })
                    .then(async registration => {
                        console.log('ServiceWorker erfolgreich registriert:', registration.scope);
                        console.log('ServiceWorker Status:', registration.active ? 'aktiv' : 'nicht aktiv');
                        
                        // Warte auf Aktivierung
                        if (registration.installing) {
                            console.log('ServiceWorker wird installiert...');
                            registration.installing.addEventListener('statechange', e => {
                                console.log('ServiceWorker State:', e.target.state);
                            });
                        }
                        
                        if (navigator.onLine) {
                            // Bei Online-Betrieb ServiceWorker updaten
                            console.log('Prüfe auf ServiceWorker Updates...');
                            await registration.update();
                        }
                        
                        // Cache-Status überprüfen
                        if ('caches' in window) {
                            const cacheNames = await caches.keys();
                            console.log('Verfügbare Caches:', cacheNames);
                        }
                    })
                    .catch(err => {
                        console.error('ServiceWorker Registrierung fehlgeschlagen:', err);
                        console.error('Error Details:', {
                            name: err.name,
                            message: err.message,
                            stack: err.stack
                        });
                        statusfeld.innerText = 'Offline-Modus nicht verfügbar: ' + err.message;
                    });
            } else {
                console.error('Service Worker nicht unterstützt in diesem Browser');
                statusfeld.innerText = 'Offline-Modus nicht unterstützt';
            }
        }    


        function configuration() {
            // Konfigutarionen - Ansicht anpassen je nach Benutzergruppe
            if (config.wartungsmodus == "true") document.getElementById("Wartungsfenster").style = "display: flex"; // Wartungsmodus
            if (config.tagesabrechnung == "false") document.getElementById("bt_tagesabrechnung").style = "display: none";
            if (config.tageszusammenfassung == "false") document.getElementById("bt_tageszusammenfassung").style = "display: none";
            if (config.kundentagesübersicht == "false") document.getElementById("bt_kundentagesübersicht").style = "display: none";
            if (config.preisanpassungessen == "false") document.getElementById("bt_mittagspreis").style = "display: none";
            
            if (config.bildschirmschoner>0) {
            document.addEventListener('mousemove', resetTimer);
            document.addEventListener('mousedown', resetTimer);
            document.addEventListener('keypress', resetTimer);
            document.addEventListener('touchstart', resetTimer);
            document.addEventListener('scroll', resetTimer);
            resetTimer(); // aktiviert den Bildschirmschoner
            }
            document.getElementById("version").innerText = config.Version;
        }

        async function loadJSON(url) {
            try {
            // Immer vom Netzwerk laden, nie aus dem Browser-Cache
            const response = await fetch(url, {
                cache: 'no-cache',
                headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache'
                }
            });
            if (!response.ok) {
                throw new Error("Netzwerkantwort war nicht ok: " + response.statusText);
            }
            console.log(`${url} erfolgreich vom Netzwerk geladen`);
            return await response.json();
            } catch (error) {
            // Bei Netzwerkfehler: Versuche aus dem Service Worker Cache zu laden
            console.warn(`Netzwerkfehler bei ${url}, versuche aus Cache zu laden:`, error);
            if ('caches' in window) {
                try {
                // Suche nach dem neuesten clubcash-Cache (unterstützt beliebige Versionsnummern)
                const cacheNames = await caches.keys();
                const clubcashCache = cacheNames.find(name => name.startsWith('clubcash-'));
                if (clubcashCache) {
                    const cache = await caches.open(clubcashCache);
                    const cachedResponse = await cache.match(url);
                    if (cachedResponse) {
                        console.log(`${url} aus Cache ${clubcashCache} geladen (Offline-Modus)`);
                        return await cachedResponse.json();
                    }
                }
                } catch (cacheError) {
                console.error(`Cache-Fehler bei ${url}:`, cacheError);
                }
            }
            throw new Error(`Datei ${url} konnte weder vom Netzwerk noch aus dem Cache geladen werden: ${error.message}`);
            }
        }

        async function loadCSV(url) {
            const response = await fetch(url);
            const data = await response.text();

            // Split into lines 
            const lines = data.trim().split('\n');

            // First line contains column headers
            const headers = lines[0].split(';');

            // Process remaining lines
            const result = lines.slice(1).map(line => {
            const values = line.split(';');
            // Create object with column headers as keys
            return headers.reduce((obj, header, index) => {
                // Filter quotes from values
                obj[header] = values[index] ? values[index].replace(/"/g, '') : values[index];
                return obj;
            }, {});
            });

            return result;
        }

        // ========================================
        // OFFLINE-FUNKTIONALITÄT
        // ========================================

        function updateOfflineCounter() {
            let offlineData = JSON.parse(localStorage.getItem('offlineVerkäufe')) || [];
            const offlineElement = document.getElementById('offlineDS');
            if (offlineElement) {
            offlineElement.innerText = offlineData.length;
            console.log("Offline-Datensätze im lokalen Speicher: " + offlineData.length);
            }
        }

        function speichereOfflineVerkauf(verkaufsdaten) {
            console.log("Speichere Verkauf offline:", verkaufsdaten);
            let offlineVerkäufe = JSON.parse(localStorage.getItem('offlineVerkäufe') || '[]');
            offlineVerkäufe.push(verkaufsdaten);
            localStorage.setItem('offlineVerkäufe', JSON.stringify(offlineVerkäufe));
            updateOfflineCounter();
        }

        async function syncOfflineData() {
            if (isSyncing) {
                console.log("Synchronisation läuft bereits");
                return;
            }
            
            const offlineVerkäufe = JSON.parse(localStorage.getItem('offlineVerkäufe') || '[]');
            if (offlineVerkäufe.length === 0) return;

            isSyncing = true;
            console.log(`Starte Synchronisation von ${offlineVerkäufe.length} Verkäufen`);
            
            let erfolgreicheSyncs = 0;
            let fehlerhafte = [];

            for (let i = 0; i < offlineVerkäufe.length; i++) {
                try {
                    const response = await fetch("umsatz-api.php", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(offlineVerkäufe[i])
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log(`Verkauf ${i + 1} erfolgreich synchronisiert:`, result);
                        erfolgreicheSyncs++;
                    } else {
                        console.error(`Verkauf ${i + 1} Fehler: ${response.status}`);
                        fehlerhafte.push(offlineVerkäufe[i]);
                    }
                } catch (error) {
                    console.error(`Verkauf ${i + 1} Sync-Fehler:`, error);
                    fehlerhafte.push(offlineVerkäufe[i]);
                }
            }

            // Speichere nur die fehlerhaften Verkäufe zurück
            if (fehlerhafte.length > 0) {
                localStorage.setItem('offlineVerkäufe', JSON.stringify(fehlerhafte));
                statusfeld.innerText = `${erfolgreicheSyncs} Verkäufe synchronisiert, ${fehlerhafte.length} fehlgeschlagen`;
                console.log(`${erfolgreicheSyncs} Verkäufe synchronisiert, ${fehlerhafte.length} fehlgeschlagen`);
            } else {
                localStorage.removeItem('offlineVerkäufe');
                statusfeld.innerText = `${erfolgreicheSyncs} Offline-Verkäufe synchronisiert`;
                console.log(`${erfolgreicheSyncs} Offline-Verkäufe synchronisiert`);
            }
            
            updateOfflineCounter();
            isSyncing = false;
        }

        // ========================================
        // UI & NAVIGATION
        // ========================================

        function toggleMenu() {
            document.querySelector(".menu").classList.toggle("active");
        }

        function preisfenster_öffnen() {
            document.querySelector(".menu").classList.remove("active");
            preisfenster.style.display = 'flex';
            display_fenster.style.display = 'none';
        }

        function preisfenster_schliessen() {
            preisfenster.style.display = 'none';
            display_fenster.style.display = 'flex';
        }

        function eingabestopp() {
            console.log("Eingabestopp aktiviert");
            document.removeEventListener("keydown", tastenkontrolle);
            Bt_preisfenster.style.display = 'none';
            Bt_manuelleBuchung.style.display = 'none';
        }

        function Fehlerton() {
            const audioContext = new(window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.type = 'square'; // Typ des Tons, ein Rechteckton (für Fehlerton)
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // Frequenz, hier 440 Hz (A4)
            oscillator.start();

            // Stoppe den Ton nach 0.3 Sekunden
            setTimeout(() => {
            oscillator.stop();
            }, 300);
        }

        function zeigeHaken() {
            const container = document.getElementById("checkmark-container");
            const check = document.getElementById("checkmark");

            container.style.display = "flex";

            // Leichte Verzögerung, damit Transition greift
            setTimeout(() => {
            check.style.strokeDashoffset = "0";
            }, 50);
        }

        function showScreensaver() {
            div_Bildschirmschoner.style.display = 'flex';
        }

        function resetTimer() {
            clearTimeout(timeout);
            timeout = setTimeout(showScreensaver, 60000 * config.bildschirmschoner);
        }

        // ========================================
        // PRODUKT-FUNKTIONEN
        // ========================================

        function direktwahl() {
            produkte.forEach(produkt => {
            if (produkt.Sortierung > 0 && produkt.Sortierung < 13) {
                let button = document.createElement("button");
                button.innerText = produkt.Bezeichnung + " - " + produkt.Preis + " €";
                button.onclick = function() {
                produktprüfung(produkt.EAN);
                }
                document.getElementById("direktwahl").appendChild(button);
            }
            });
        }

        function produktprüfung(EANr) {
            console.log("Produktprüfung für EAN: " + EANr);
            document.querySelector(".menu").classList.remove("active"); //Menu ausblenden, sollte es geöffnet sein. 

            let produkt = produkte.find(produkte => produkte.EAN === EANr);

            if (produkt) {
            if (produkt.Menge == "true") {
                ProduktTemp = produkt;  // Speichert das Produkt in einer temporären Variable, um es später zu verwenden
                warenkorbüberschrift()
                document.getElementById("einheit").innerText = "l";
                //eingabestopp(); 
                //öffnet die Tastatur für die Mengeneingabe
                tastatur.style.display = 'block';
                statusfeld.innerHTML = "Bitte Menge für <b>&nbsp;" + produkt.Bezeichnung + "&nbsp;</b> in Litern eingeben";
                spritt = true;
                return
            }

            warenkorbüberschrift();
            warenkorb.push(produkt);
            warenkorbaddition(produkt);
            eingabe = "";
            }
        }

        function preisliste() {
            produkte.sort((a, b) => a.Sortierung - b.Sortierung);
            preislisten_tbody.innerHTML = "";
            produkte.forEach(produkt => {
            if (produkt.EAN == "") { // Leere Zeilen überspringen
                return;
            }
            let zeile = preislisten_tbody.insertRow();
            let zelle1 = zeile.insertCell();
            zelle1.innerText = produkt.Bezeichnung;
            zelle1.className = "preisliste_rechts_groß";
            let zelle2 = zeile.insertCell();
            zelle2.innerText = produkt.Preis + " €";
            zelle2.className = "preisliste_rechts_groß";
            let zelle3 = zeile.insertCell();
            zelle3.className = "plus-button-zelle";
            zelle3.innerHTML = "<button onclick='aus_preisliste_buchen(\"" + produkt.EAN + "\")' class='plus-button'>+</button>";
            
            });
        }

        function aus_preisliste_buchen(EAN_Preisliste) {
            produktprüfung(EAN_Preisliste);
            preisfenster.style.display = 'none';
            display_fenster.style.display = 'grid';
        }

        function mittagspreis() {
           
            eingabestopp();
            statusfeld.innerText = "Preisänderung für das Essen";
            Bt_preisfenster.style.display = 'none';
            Bt_manuelleBuchung.style.display = 'none';
            navbar.style.display = 'none';

            summenfeld.innerText = "0.00";
            eingabestring = "";

            if (!isOnline) {    
            datenfeld.innerHTML = `<div class="box_zentrieren"><h1> Das System ist offline! Es ist derzeit nicht möglich, den Preis anzupassen. Bitte warte, bis das System wieder online ist, oder buche das Essen als <br> *manuelle Buchung*.</h1></div>`;
            return;
            }

            tastatur.style.display = 'block';

            datenfeld.innerHTML = `<div class="box_zentrieren"><h1> Bitte gebe den neuen Preis für das Essen ein.</h1></div>`;
        
            document.getElementById('BT_EingabeBestätigt').onclick = function() {
            let preisNum = parseFloat(zifferneingabefeld.firstChild.nodeValue);
            update_mittagspreis(preisNum);
            };
        }

        function update_mittagspreis(neuerPreis) {
            document.getElementById('abbruch').innerText="zurück";
            const produkt = produkte.find(item => item.EAN === "1");
            if (!produkt) {
            statusbar.innerHTML = "Fehler in der Produktdatenbank!";
            return;
            }

            produkt.Preis = neuerPreis.toFixed(2); // Preis aktualisieren
        
            fetch('json-schreiben.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                data: produkte,
                filename: '../daten/produkte.json'
            })
            })
            .then(response => response.json())
            .then(result => {
            if (result.success) {
                console.log('JSON erfolgreich gespeichert');
                datenfeld.innerHTML = `
                <p><p class="zentriert preis-geaendert-erfolg"><b>Der Preis wurde geändert!<b></p>
                <p class="zentriert preis-geaendert-info">Der neue Preis für das heutige Essen beträgt jetzt: </p>
                <h1 class="zentriert preis-geaendert-wert">` + zifferneingabefeld.firstChild.nodeValue + ` €</h1>
                `;
                tastatur.style.display = 'none';
            } else {
                console.error('Fehler:', result.error);
                datenfeld.innerHTML = '<p class="zentriert preis-fehler"><b>Preis konnte nicht angepasst werden weil: ' + result.error;
            }
            })
            .catch(error => {
            console.error('Fehler:', error)
            datenfeld.innerHTML = '<p class="zentriert preis-fehler"><b>Preis konnte nicht angepasst werden weil: ' + error;
            });
        }

        // ========================================
        // WARENKORB-FUNKTIONEN
        // ========================================

        function warenkorbüberschrift() {
            if (warenkorb.length == 0) {
            warenkorb2 = [];
            tbody.innerHTML = ""; // Bestehenden Inhalt löschen
            thead.innerHTML = `
            <tr>
                        <th class="produktspalte" >Produkt</th>
                        <th class="preisspalteWarenkorb">Preis</th>
                        <th class="leerspalte"></th>		
                </tr>
             `;
            }
        }

        function warenkorbaddition(produkt) {
            statusfeld.innerText = "Produkt dem Warenkorb hinzugefügt."

            summe = summe + parseFloat(produkt.Preis);

            summenfeld.innerText = summe.toFixed(2);

            let zeile = tbody.insertRow();
            let zelle1 = zeile.insertCell();
            zelle1.innerText = produkt.Bezeichnung;
            zelle1.className = "rechts_groß";
            let zelle2 = zeile.insertCell();
            zelle2.innerText = produkt.Preis + " €";
            zelle2.className = "rechts_groß";
            if (produkt.EAN != 9990000000000) {
            let zelle3 = zeile.insertCell();
            zelle3.innerHTML = "<button onclick='produktprüfung(`" + produkt.EAN + "`)' class='plus-button'>+</button>"; 
            zelle3.className = "plus-button-zelle";}
        }

        function manuell() {
            tastatur.style.display = "block";
            statusfeld.innerText = "manuelle Buchung";
            summenfeld.innerText = "0.00";
            document.querySelector(".menu").classList.remove("active");
            eingabestring = "";
        }

        function meingabe(x) {
            console.log("Eingabe: " + x);
            let manuelles_Produkt = [];

            if (x == "E") {
            if (eingabestring == "") {
                statusfeld.innerText = "Keine Eingabe erfolgt.";
                tastatur.style.display = "none";
                return;
            }
            if (spritt) {
                eingabestring = (eingabestring / 100).toFixed(2);
                eingabestring = parseFloat(eingabestring).toFixed(2);
                let sprittpreis = parseFloat(eingabestring);
                spritt = false; // Zurücksetzen der Spritt-Variable
                let Produkttext = ProduktTemp.Bezeichnung + " (" + ProduktTemp.Preis + "€/l * " + eingabestring + "l)";
                manuelles_Produkt = {
                EAN: ProduktTemp.EAN,
                Bezeichnung: Produkttext,
                Preis: (sprittpreis * ProduktTemp.Preis).toFixed(2),
                MwSt: 19,
                Kategorie: "Fuel"
                };
            } else { 
                manuelles_Produkt = {
                EAN: 9990000000000,
                Bezeichnung: "manuelle Buchung",
                Preis: (eingabestring / 100).toFixed(2),
                MwSt: 19,
                Kategorie: "manuelle Buchung"
                };
            }

            tastatur.style.display = "none";
            warenkorbüberschrift();
            warenkorb.push(manuelles_Produkt);
            warenkorbaddition(manuelles_Produkt);
            return;
            }
            eingabestring += x;
            zifferneingabefeld.innerText = (eingabestring / 100).toFixed(2);
        }

        // ========================================
        // KUNDEN-FUNKTIONEN
        // ========================================

        function kundenprüfung(KundenNr) {
            let kunde = kunden.find(kunden => kunden.schlüssel === KundenNr); // schlüssel ist die Kundennummer

            if (kunde) {
            if (!summe == 0) {

                let warenkorb2 = [];
                let now = new Date();
                // Manuelles Erstellen des Datums im Format YYYY-MM-DD
                let year = now.getFullYear();
                let month = String(now.getMonth() + 1).padStart(2, '0'); // Monat ist 0-basiert, daher +1
                let day = String(now.getDate()).padStart(2, '0'); // Den Tag immer auf 2 Stellen auffüllen
                let datum = `${year}-${month}-${day}`;
                let zeit = now.toTimeString().split(" ")[0].slice(0, 5);

                if (!kunde.uid) {
                kunde.uid = kunde.schlüssel; // Wenn keine Kundennummer vorhanden ist, setze den Schlüssel als Kundennummer
                }

                for (ds of warenkorb) {
                let ds2 = {
                    Datum: datum,
                    Zeit: zeit,
                    Terminal: terminal,
                    Schlüssel: kunde.schlüssel,
                    Kundennummer: kunde.uid,
                    EAN: ds.EAN,
                    Produkt: ds.Bezeichnung,
                    Kategorie: ds.Kategorie,
                    Preis: ds.Preis,
                    MwSt: ds.MwSt
                }
                warenkorb2.push(ds2);
                }

                übertragung_umsatz(warenkorb2);

                tbody.innerHTML = `
    <tr>
        <td colspan="3" class="zentriert">
            <p class="warenkorb-uebertragung-text">Alle Produkte aus dem Warenkorb
            <br>wurden dem Kundenkonto von
            <br><b>` + kunde.firstname + ` ` + kunde.lastname + `</b>
            <br>übertragen.</p>
            <div id="checkmark-container">
                <svg width="25cqw" height="25cqw" viewBox="0 0 100 100">
                <path id="checkmark" d="M25 50 L45 70 L75 35"
                    stroke="#4CAF50" stroke-width="8"
                    fill="none"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-dasharray="100"
                    stroke-dashoffset="100" />
                </svg>
            </div>
        </td>
    </tr>
`;

                thead.innerHTML = "";

                eingabe = "";
                warenkorb = [];
                warenkorb2 = [];
                summe = 0;

                abbruch.innerText = "zurück";

                eingabestopp();

                zeigeHaken(); // Zeige Häkchenanimation an

                setTimeout(() => {
                window.location.reload(true); // Seite wird nach 3 Sekunden neu geladen
                }, 3000); 

            } else {
                eingabe = "";
                statusfeld.innerText = "Kontoübersicht " + kunde.lastname + ", " + kunde.firstname;
                kundenkontoübersicht(KundenNr);
            }
            }
        }

        async function kundenkontoübersicht(Schlüsselnummer) {
            document.getElementById('abbruch').innerText="zurück";
            eingabestopp();

            if (!isOnline) {    
            datenfeld.innerHTML = `<div class="box_zentrieren"><h1> Das System ist offline! Es ist derzeit nicht möglich, deine Umsätze anzugezeigen. Bitte warte, bis das System wieder online ist, oder logge dich in das Onlineportal ein.</h1></div>`;
            return;
            }

            let kontosumme = 0.0;
            let kunde = kunden.find(kunden => kunden.schlüssel === Schlüsselnummer);

            try {
            let response = await fetch("kundenkontouebersicht-cvs.php", {
                method: "POST",
                headers: {
                "Content-Type": "application/json"
                },
                body: JSON.stringify(kunde.uid) // Sende die Kundennummer als JSON
            });

            if (!response.ok) {
                throw new Error("Netzwerkantwort war nicht ok: " + response.statusText);
            }

            let data = await response.json();

            if (data.status !== "success") {
                console.error("Fehler beim Abrufen:", data.message);
                return;
            }

            //sortiere die Daten nach Datum und Zeit absteigend
            data.data.sort((a, b) => {
                let dateA = new Date(a.Datum + " " + a.Zeit);
                let dateB = new Date(b.Datum + " " + b.Zeit);
                return dateB - dateA; // Absteigend sortieren
            });

            tbody.innerText = ""; // Bestehenden Inhalt löschen

            thead.innerHTML = `
            <tr>
            <th class="datumspalte">Datum</th>
            <th>Zeit</th>
            <th class="tagesabrechnung-th-left">T</th>
            <th class="tagesabrechnung-th-left">Produkt</th>
             <th class="rechts">Preis</th>
             </tr>
             `;

            data.data.forEach(row => {

                kontosumme += parseFloat(row.Preis);

                let tr = document.createElement("tr");
                tr.innerHTML = `
            <td class="zentriert">` + row.Datum + `</td>
            <td class="zentriert">` + row.Zeit + `</td>
            <td class="zentriert">` + row.Terminal + `</td>
            <td>` + row.Produkt + `</td>
            <td class="währung">` + row.Preis + ` €</td>
            `;
                tbody.appendChild(tr);

            });

            summenfeld.innerText = kontosumme.toFixed(2);

            warenkorb = [];

            } catch (error) {
            console.error("Fehler beim Laden der Daten:", error);
            }
        }

        // ========================================
        // BERICHTS-FUNKTIONEN
        // ========================================

        async function tagesabrechnung() {
            
            document.getElementById('abbruch').innerText="zurück";
            tastatur.style.display = 'none';

            eingabestopp();

            if (!isOnline) {    
            datenfeld.innerHTML = `<div class="box_zentrieren"><h1> Das System ist offline! Es ist derzeit nicht möglich, die Tagesumsätze anzugezeigen. Bitte warte, bis das System wieder online ist, oder logge dich in das Onlineportal ein.</h1></div>`;
            return;
            }

            let tagessumme = 0.0;

            try {
            let response = await fetch("tagesabrechnung-csv.php");
            console.log(response);
            if (!response.ok) {
                throw new Error("Netzwerkantwort war nicht ok: " + response.statusText);
            }

            let data = await response.json();

            if (data.status !== "success") {
                console.error("Fehler beim Abrufen:", data.message);
                return;
            }

            tbody.innerText = ""; // Bestehenden Inhalt löschen

            thead.innerHTML = `
            <tr>
            <th>T</th>
            <th>Zeit</th>
            <th class="kundenspalte">Kunde</th>
            <th class="tagesabrechnung-th-left">Produkt</th>
            <th class="preisspalte">Preis</th>
            </tr>
            `;
        
            data.data.forEach(row => {

                let kunde = kunden.find(kunden => kunden.schlüssel === row.Schlüssel);

                if (!kunde) {
                return console.error("Kunde nicht gefunden für Schlüssel: " + row.Schlüssel);
                }

                let tr = document.createElement("tr");
                tr.innerHTML = `
            <td class="zentriertTop" class="top">` + row.Terminal + `</td>
            <td class="zentriertTop" class="top">` + row.Zeit + `</td>
            <td class="top">` + kunde.lastname + ", " + kunde.firstname + `</td>
            <td class="top">` + row.Produkt + `</td>
            <td class="währung">` + row.Preis + ` €</td>
            `;
                tbody.appendChild(tr);
            });

            statusfeld.innerText = "Tagesabrechnung";

            summenfeld.innerText = tagessumme.toFixed(2);

            warenkorb = [];

            } catch (error) {
            console.error("Fehler beim Laden der Daten:", error);
            statusfeld.innerText = "Fehler beim Laden der Daten:" + error;
            }
        }

        async function tageszusammenfassung() {
            document.getElementById('abbruch').innerText="zurück";
            eingabestopp();
            tastatur.style.display = 'none';

            if (!isOnline) {    
            datenfeld.innerHTML = `<div class="box_zentrieren"><h1> Das System ist offline! Es ist derzeit nicht möglich, die Tagesumsätze anzugezeigen. Bitte warte, bis das System wieder online ist, oder logge dich in das Onlineportal ein.</h1></div>`;
            return;
            }

            let tagessumme = 0.0;

            try {
            let response = await fetch("tagesabrechnung-csv.php");
            if (!response.ok) {
                throw new Error("Netzwerkantwort war nicht ok: " + response.statusText);
            }

            let data = await response.json();

            if (data.status !== "success") {
                console.error("Fehler beim Abrufen:", data.message);
                return;
            }

            const productCounts = data.data.reduce((acc, row) => {

                const product = row.Produkt; // Produktname
                const price = parseFloat(row.Preis); // Preis

                if (acc[product]) {
                acc[product].count += 1; // Falls das Produkt schon im Objekt ist, erhöhe die Zählung
                acc[product].totalPrice += price; // und addiere den Preis

                } else {
                acc[product] = {
                    count: 1, // Erstes Vorkommen des Produkts
                    unitPrice: price, // Einzelpreis
                    totalPrice: price // Summenpreis (zu Beginn gleich dem Einzelpreis) erste Mal ist, setze den Zähler auf 1
                };
                }
                return acc;
            }, {});

            tbody.innerText = ""; // Bestehenden Inhalt löschen

            thead.innerHTML = `
            <tr>
            <th>Anzahl</th>
            <th class="links">Produkt</th>   
            <th class="rechts">Einzelpreis</th>
            <th class="rechts">Summe</th>
             </tr>
             `;

            for (const [product, details] of Object.entries(productCounts)) {

                let tr = document.createElement("tr");

                if (product == "manuelle Buchung") {
                tr.innerHTML = `
            <td class="zentriert"> ${details.count} </td>
            <td> ${product} </td>
            <td class="währung"> * </td>
            <td class="währung"> ${details.totalPrice.toFixed(2)} €</td>
            `;
                tbody.appendChild(tr);

                tagessumme += details.totalPrice;

                continue;
                }

                tr.innerHTML = `
            <td class="zentriert"> ${details.count} </td>
            <td> ${product} </td>
            <td class="währung"> ${details.unitPrice.toFixed(2)} €</td>
            <td class="währung"> ${details.totalPrice.toFixed(2)} €</td>
            `;
                tbody.appendChild(tr);

                tagessumme += details.totalPrice;

            }

            statusfeld.innerText = "Tageszusammenfassung";
            summenfeld.innerText = tagessumme.toFixed(2);
            warenkorb = [];

            } catch (error) {
            console.error("Fehler beim Laden der Daten:", error);
            statusfeld.innerText = "Fehler beim Laden der Daten:", error;
            }
        }

        async function kundentagesübersicht() {
            document.getElementById('abbruch').innerText="zurück";
            eingabestopp();
            tastatur.style.display = 'none';

            if (!isOnline) {    
            datenfeld.innerHTML = `<div class="box_zentrieren"><h1> Das System ist offline! Es ist derzeit nicht möglich, die Tagesumsätze anzugezeigen. Bitte warte, bis das System wieder online ist, oder logge dich in das Onlineportal ein.</h1></div>`;
            return;
            }

            let tagessumme = 0.0;

            try {
            let response = await fetch("tagesabrechnung-csv.php");
            if (!response.ok) {
                throw new Error("Netzwerkantwort war nicht ok: " + response.statusText);
            }

            let data = await response.json();

            if (data.status !== "success") {
                console.error("Fehler beim Abrufen:", data.message);
                return;
            }

            const sortedByCustomer = data.data.sort((a, b) => a.Kundennummer.localeCompare(b.Kundennummer));

            // Produkte zählen, Einzelpreis und Gesamtsumme berechnen
            const customerData = sortedByCustomer.reduce((acc, row) => {
                const customer = row.Kundennummer; // Kunde
                const product = row.Produkt; // Produkt
                const price = parseFloat(row.Preis); // Preis als Zahl

                // Wenn der Kunde noch nicht im Accumulator ist, hinzufügen
                if (!acc[customer]) {
                acc[customer] = {};
                }

                // Wenn das Produkt noch nicht für diesen Kunden existiert
                if (!acc[customer][product]) {
                acc[customer][product] = {
                    count: 0,
                    unitPrice: price,
                    totalPrice: 0
                };
                }

                // Produktanzahl erhöhen und Gesamtsumme berechnen
                acc[customer][product].count += 1;
                acc[customer][product].totalPrice += price;

                return acc;

            }, {});

            thead.innerHTML = "";
            tbody.innerText = ""; // Bestehenden Inhalt löschen

            for (const Kunde1 in customerData) {

                let kunde = kunden.find(kunden => kunden.uid === Kunde1);

                let tr = document.createElement("tr");
                tr.innerHTML = `
            <td colspan="4" 
            id="Namenfeld"
            >` + kunde.lastname + `, ` + kunde.firstname + `</td>
            `;
                tbody.appendChild(tr);
                
                let kundensumme = 0.0;

                for (const [product, details] of Object.entries(customerData[Kunde1])) {


                let tr = document.createElement("tr");

                if (product == "manuelle Buchung") {
                    tr.innerHTML = `
                <td class="zentriert">` + details.count + `</td>
                <td class="links">` + product + `</td>
                <td class="währung">*</td>
                <td class="währung">` + details.totalPrice.toFixed(2) + ` €</td>
              `;
                } else {
                    tr.innerHTML = `
                <td class="zentriert">` + details.count + `</td>
                <td class="links">` + product + `</td>
                <td class="währung">` + details.unitPrice.toFixed(2) + ` €</td>
                <td class="währung">` + details.totalPrice.toFixed(2) + ` €</td>
              `;
                }

                tbody.appendChild(tr);
                kundensumme += details.totalPrice;
                }

                tagessumme += kundensumme;

                let tr2 = document.createElement("tr");
                tr2.innerHTML = `
            <td></td>
            <td></td>
            <td></td>
            <td class="währung kunden-summen-padding"><b>` + kundensumme.toFixed(2) + ` €</b></td>
            `;
                tbody.appendChild(tr2);

            }

            statusfeld.innerText = "Kunden Tagesübersicht";
            summenfeld.innerText = tagessumme.toFixed(2);
            warenkorb = [];

            } catch (error) {
            console.error("Fehler beim Laden der Daten:", error);
            statusfeld.innerText = "Fehler beim Laden der Daten:", error;
            }
        }

        function offlineVerkäufe() {
            
            let offlineHTML = '';

            let offlineVerkäufe = JSON.parse(localStorage.getItem('offlineVerkäufe')) || [];

            if (offlineVerkäufe.length === 0) {
            offlineHTML = `<p style="text-align:center;">Es sind keine offline Verkäufe gespeichert.</p>`;
            return offlineHTML;
            }

            offlineHTML = "<table>"; // Bestehenden Inhalt löschen

            offlineHTML += `
            <tr>
            <th>Datum</th>
            <th>Zeit</th>
            <th>Kunde</th>
            <th>Produkt</th>
            <th class="preisspalte">Preis</th>
            </tr>
            `;

            for (const verkauf of offlineVerkäufe) {
                for (const ds of verkauf) {
                    offlineHTML += `
                        <tr>
                            <td class="zentriert">` + ds.Datum + `</td>
                            <td class="zentriert">` + ds.Zeit + `</td>
                            <td class="zentriert">` + ds.Kundennummer + `</td>
                        <td>` + ds.Produkt + `</td>
                        <td class="währung">` + ds.Preis + ` €</td>
                    `;
                }  
            };
            offlineHTML += "</table>";
            return offlineHTML;
        }

        // ========================================
        // SYSTEM-FUNKTIONEN
        // ========================================

        function loggs() {

            let logsHTML = '';
                        
                        // Log-Einträge
                        if (logs.log.length > 0) {
                            logs.log.forEach((entry, index) => {
                                logsHTML += `<p><b>[${index}]</b> ${JSON.stringify(entry)}</p>`;
                            });
                        }
                        
                        // Warning-Einträge
                        if (logs.warn.length > 0) {
                            logsHTML += '<h3>Warnings:</h3>';
                            logs.warn.forEach((entry, index) => {
                                logsHTML += `<p style="color: orange;"><b>[${index}]</b> ${JSON.stringify(entry)}</p>`;
                            });
                        }
                        
                        // Error-Einträge
                        if (logs.error.length > 0) {
                            logsHTML += '<h3>Errors:</h3>';
                            logs.error.forEach((entry, index) => {
                                logsHTML += `<p style="color: red;"><b>[${index}]</b> ${JSON.stringify(entry)}</p>`;
                            });
                        }
                        
                        if (logs.log.length === 0 && logs.warn.length === 0 && logs.error.length === 0) {
                            logsHTML += '<p>Keine Logs vorhanden.</p>';
                        }

                        
                        return logsHTML;

        }

        async function systeminfo() {
            preisfenster.style.display = 'none'; //sollte das Preisfenster noch offen sein, wird es geschlossen
            tastatur.style.display = 'none'; //sollte die Tastatur noch offen sein, wird sie geschlossen
            eingabestopp();
            document.getElementById('abbruch').innerText="zurück";
            statusfeld.innerText = "Systeminformationen";
            
            // Cache-Informationen abrufen
            let cacheInfo = 'Nicht verfügbar';
            let cacheDetails = '';
            if ('caches' in window) {
            try {
                const cacheNames = await caches.keys();
                cacheInfo = cacheNames.join(', ') || 'Keine Caches gefunden';
                
                // Details für jeden Cache
                for (const cacheName of cacheNames) {
                const cache = await caches.open(cacheName);
                const keys = await cache.keys();
                cacheDetails += `<p><b>${cacheName}</b>: ${keys.length} Dateien</p>`;
                cacheDetails += '<ul style="margin:0px;">';
                keys.forEach(req => {
                    const url = new URL(req.url);
                    cacheDetails += `<li>${url.pathname}</li>`;
                });
                cacheDetails += '</ul>';
                }
            } catch (e) {
                cacheInfo = 'Fehler: ' + e.message;
            }
            }
            
            html = `
                <style>
                    p, li, th {
                    margin: 0px;
                    font-size: 1.5cqw;
                    }
                    h2, h3 {
                    font-size: 2cqw;
                    font-weight: bold; 
                    margin: 2px 0;
                    }
                </style>
                <p>Terminal: <b>${terminal}</b></p>
                <p>Version: <b>${config.Version}</b></p>
                <p>Vereinsname: <b>${config.Vereinsname}</b></p>
                <p>Vereinsname Abk.: <b>${config.VereinsnameAbk}</b></p>
                <p>Wartungsmodus: <b>${config.wartungsmodus}</b></p>
                <p>Tagesabrechnung: <b>${config.tagesabrechnung}</b></p>
                <p>Tageszusammenfassung: <b>${config.tageszusammenfassung}</b></p>
                <p>Kundentagesübersicht: <b>${config.kundentagesübersicht}</b></p>
                <p>Preisanpassung Essen: <b>${config.preisanpassungessen}</b></p>
                <p>Bildschirmschoner: <b>${config.bildschirmschoner} Minuten</b></p>
                <p>Offline erlaubt: <b>${config.OfflineErlaubt}</b></p>
                <p>Letzter Speicherzeitpunkt im Lokalspeicher: <b>${localStorage.getItem('letzterSpeicherZeitpunkt')}</b></p>
                <hr>
                <h2>Cache-Status</h2>
                <p>Caches: <b>${cacheInfo}</b></p>
                ${cacheDetails}
               `; 

            html +=`<hr>
                <h2>Logs</h2>
            `;   
            html += loggs();

            html +=`<hr>
                <h2>Offline Verkäufe</h2>
            `;
            html += offlineVerkäufe();      

            datenfeld.innerHTML = html;
        }

        function info() {
            Bt_preisfenster.style.display = 'none';
            Bt_manuelleBuchung.style.display = 'none';
            navbar.style.display = 'none';
            tastatur.style.display = 'none';
            statusfeld.innerText = "Information zum Kassensystem";
            $("#datenfeld").load("../info.html");

            eingabestopp();
            Bt_manuelleBuchung.style.display = 'none';
            
            document.getElementById('abbruch').innerText="zurück";
        }

        function sonderfunktionen(EANr) {
            switch (EANr) {
            case "1111":
                tagesabrechnung();
                eingabe="";
                break;
            case "2222":
                tageszusammenfassung();
                eingabe="";
                break;
            case "3333":
                kundentagesübersicht();
                eingabe="";
                break;
            case "4444":
                mittagspreis();
                eingabe="";
                break;
            }
        }

        // ========================================
        // DATENÜBERTRAGUNG
        // ========================================

        async function übertragung_umsatz(data) {
            // Wenn offline, speichere direkt
            if (!isOnline) {
                speichereOfflineVerkauf(data);
                statusfeld.innerText = "Verkauf offline gespeichert";
                console.log("Verkauf offline gespeichert");
                return;
            }

            // Versuche online zu übertragen
            try {
                const response = await fetch("umsatz-api.php", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`Server-Fehler: ${response.status}`);
                }

                const result = await response.json();
                console.log(result);
                statusfeld.innerText = "Verkauf online gespeichert";
                console.log("Verkauf online gespeichert");
                return true; // Erfolgreich übertragen
                
            } catch (error) {
                console.error("Fehler:", error);
                
                // Nur offline speichern wenn nicht während Sync-Vorgang
                // (während Sync ist der Verkauf bereits in offlineVerkäufe)
                if (!isSyncing) {
                    speichereOfflineVerkauf(data);
                    statusfeld.innerText = "Fehler - Verkauf offline gespeichert";
                    console.log("Fehler - Verkauf offline gespeichert");
                }
                return false; // Fehler bei Übertragung
            }
        }
    </script>

</body>

</html>